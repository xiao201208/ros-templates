## **方案概览**

大模型虽然可以理解并生成自然语言，但由于缺乏特定领域的专业知识、没有企业的私域知识、知识更新不及时等问题，无法直接用于企业的AI智能客服。为了解决这一问题，企业可以采用RAG技术，从外部知识库（企业的私域知识）检索知识。召回的知识将和原始查询融合成prompt，为大模型提供更丰富的上下文信息，从而生成更加准确的回答。本方案将指导您快速创建一个RAG应用（AnalyticDB for PostgreSQL向量存储+通义千问LLM模型），实现企业的AI智能客服，更高效地解决客户问题。

## **方案优势**

* **简单易用：**只需简单的页面点击，即可实现知识检索增强，使大模型有更丰富的上下文信息并生成更准确的答案。同时，本方案提供智能客服的示例代码，方便您快速体验AI智能客服。
* **灵活且安全管理**：向量数据存储在AnalyticDB for PostgreSQL，企业可灵活管理数据。配套的审计、权限管理等功能可满足企业安全合规需求。
* **性价比高：**完成本方案的部署及体验，预计产生费用不超过10元（假设您选择部署准备中相关规格资源，且运行时间不超过1小时，如果调整了资源规格，请以控制台显示的价格以及最终账单为准）。

## **方案架构**

在阿里云上搭建的云上私有网络如图所示。实际部署时，您可以根据资源规划修改部分设置，但最终形成的运行环境与下图相似。

![image](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/1258685371/CAEQTxiBgICLquOpixkiIDdhNDEyYzZlZTA4MzQ5MWM5MmM2ZDc1NTJmZTExMmZl4283193_20240408150342.693.svg)

本方案的技术架构包括以下基础设施和云服务：

* 1个专有网络 VPC：将云原生数据仓库 AnalyticDB PostgreSQL 版部署在专有网络中。
* 1台交换机：将云服务器 ECS实例和云原生数据仓库 AnalyticDB PostgreSQL 版实例部署在交换机中，实现它们之间的网络通信。
* 1台云服务器 ECS：用于部署智能客服。
* 1个云原生数据仓库 AnalyticDB PostgreSQL 版实例：提供向量数据存储和检索服务。
* 百炼：一站式的企业专属大模型生产平台。在本方案中，提供通义千问LLM模型的调用以及知识索引功能。

## **方案部署**
### **部署准备**

开始部署前，请按以下指引完成账号申请、账号充值和授权。

### **准备账号**

1. 如果您还没有阿里云账号，请访问[阿里云账号注册页面](https://account.aliyun.com/register/qr_register.htm)，根据页面提示完成注册并进行个人实名认证。阿里云账号是您使用云资源的付费实体，因此是部署方案的必要前提。
2. [为阿里云账号充值](https://help.aliyun.com/document_detail/324650.html)。本方案的云资源支持按量付费，且默认设置均采用按量付费引导操作。如果确定任何一个云资源采用按量付费方式部署，账户余额都必须大于等于100元。

### **一键部署**

资源编排（ROS）可以让您通过YAML或JSON文件清晰简洁地描述所需的云资源及其依赖关系，然后自动化地创建和配置这些资源。您可以通过下方提供的ROS一键部署链接，来自动化地完成这些资源的创建和配置。

* 部署1个专有网络 VPC。
* 部署1台交换机。
* 部署1台云服务器 ECS，并在服务器上部署Python3.9环境和AI智能客服的示例代码。
* 部署1个云原生数据仓库 AnalyticDB PostgreSQL 版实例。

1. 开通阿里云百炼大模型服务平台
    1. 登录阿里云账号，访问[**大模型服务平台百炼控制台**](https://bailian.console.aliyun.com/#/home)。
    2. 在左侧导航栏选择模型广场/应用广场，均可点击开通模型调用服务。开通调用服务后才能测试模型体验、调用模型或应用体验服务。
    3. 点击**去开通**按钮，勾选同意协议，点击**确认开通**，等待服务开通成功提示。即服务开通成功。
2. 创建大模型应用并获取凭证
    1. 进入[百炼控制台](https://bailian.console.aliyun.com/)，选择左侧导航栏**我的应用**，在页面右侧点击**新增应用**。在对话框，选择智能体应用并创建。
    ![image](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/9557807271/p852379.png)
    2. 在**应用设置**页面，单击选择模型中的**设置**，在弹出来的模型选择框中点击**选择模型**，在模型列表中选择**通义千问-Plus**，其他参数保持默认。
        > 您也可以选择输入Prompt，比如设定大模型的角色，以便更专业地回答客户咨询。
    ![image](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/1699507271/p851017.png)
    3. 单击右上角**发布**。在页面右侧，输入问题验证模型效果。您会发现，目前它还无法作为某个手机厂商的客服去回答该公司的手机商品信息。我们将在步骤4中解决这一问题。
    ![image](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/0715232271/p824612.png)
    4. 在顶部导航栏右侧，点击人型图标，点击API-KEY进入我的API-KEY页面。在页面右侧，点击**创建我的API-KEY**，在弹出窗口中创建一个新 API-KEY。保存 API-KEY 到本地用于后续配置。
    ![image](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/9557807271/p852385.png)
    5. 在应用列表中可以查看百炼应用ID。
    ![image](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/9557807271/p852387.png)
3. 一键部署AI智能客服
    1. 打开[一键配置模板链接](https://ros.console.aliyun.com/region/stacks/create?templateUrl=https://ros-public-templates.oss-cn-hangzhou.aliyuncs.com/service_template/technical-solution/AnalyticDB-and-Bailian-system.yml&hideStepRow=true&hideStackConfig=true&pageTitle=AnalyticDB与通义千问搭建AI智能客服&disableRollback=false&isSimplified=true&disableNavigation=true&productNavBar=disabled)前往ROS控制台，系统自动打开使用新资源创建的资源栈页面。（在资源栈页面进行ECS配置填写及百炼模型应用信息填写，参照以下步骤2所示）
        > **说明** ROS控制台默认处于您上一次访问控制台时的地域，请根据您创建的资源所在地域修改地域后再执行下一步。
    2. 选择地域后（本教程以**华东1（杭州）**地域为例），在**配置模板参数**步骤中填写**资源栈名称**、**账号配置**、**ECS实例配置**等参数。
        #### **资源栈名称**
        | **参数**    | **说明**                                            | **实例值**                                               |
        |-----------|---------------------------------------------------|-------------------------------------------------------|
        | **资源栈名称** | 名称可以包含数字、字母（大小写敏感）、连字符、下划线。必须以字母开头，且长度必须小于255个字符。 | AnalyticDB\_and\_Bailian\_system\_2024-08\*\*\*\*\*\* |

        #### **ECS实例配置**
         | **参数**      | **说明**                                                                                                                 | **示例值**                                |
         |-------------|------------------------------------------------------------------------------------------------------------------------|----------------------------------------|
         | **可用区**     | 云服务器 ECS实例所在的可用区。**重要**  建议**可用区**选择华北2 可用区I、华北2 可用区H、华东1 可用区J、华东2 可用区L，避免因云原生数据仓库 AnalyticDB PostgreSQL 版资源不足造成资源栈回滚。 | 可用区J                                   |
         | **实例规格**    | 云服务器 ECS实例的架构、分类和规格配置。                                                                                                 | X86计算 通用型 g6（ecs.g6.large）  2vCPU 8GiB |
         | **ECS实例密码** | 服务器登录密码，长度8-30，必须包含三项（大写字母、小写字母、数字、 ()`~!@#$%^&\*\_-+=                                                                 | {}[]:;'<>,.?/ 中的特殊符号）。                 |
       
        #### **百炼配置**
       | **参数**           | **说明**           | **实例值**                                |
       |------------------|------------------|----------------------------------------|
       | **百炼应用的应用ID**    | 步骤2获取的百炼应用的应用ID。 | 5599ac6fa08e4b688206d56ed9\*\*\*\*\*\* |
       | **百炼应用的API-KEY** | 步骤2获取的API-KEY。   | sk-c2add8fb86f14b4fb5a5\*\*\*\*\*\*\*  |

    3. 单击**下一步:检查并确认**、确认**配置模板**、**参数**和**价格预览**详情。
    4. 单击**创建**，系统将自动创建并部署本教程所需的资源。当**资源栈信息**页面的状态显示创建成功时表示一键配置完成。
        > **说明** 创建资源，耗时约10分钟，请耐心等待。**提示：**一键部署将自动检测并引导您创建一个RAM角色策略，若出现如下**依赖报错**，请直接点击去**开通**即可!
    [image](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/1471327271/p853364.png)
    5. 单击**输出**页签，单击WebUrl的**值**即可访问AI智能客服。
4. 为大模型应用配置知识库
    1. 为大模型应用配置知识库
        1. 上传文件：在百炼控制台[数据管理](https://bailian.console.aliyun.com/#/data-center)页面中，单击**导入数据**，根据引导上传用于示例的[百炼系列手机产品介绍.docx](https://help-static-aliyun-doc.aliyuncs.com/file-manage-files/zh-CN/20240729/skkjhz/%E7%99%BE%E7%82%BC%E7%B3%BB%E5%88%97%E6%89%8B%E6%9C%BA%E4%BA%A7%E5%93%81%E4%BB%8B%E7%BB%8D.docx)。
        2. 建立索引：知识库将为上一步导入的文档建立索引，用于后续大模型回答时知识检索。
            1. 在左侧导航栏中，单击**数据应用** > **知识索引**。
            2. 在[知识索引](https://bailian.console.aliyun.com/#/knowledge-base)页面，单击**创建知识库**，设置知识库名称，选择向量存储类型为**ADB-PG**，选择在部署资源阶段创建的AnalyticDB for PostgreSQL实例。
                > **ADB-PG**，即AnalyticDB for PostgreSQL，作为统一的向量存储，可以满足多个应用的向量数据集中存储、灵活管理的需求。同时，AnalyticDB for PostgreSQL提供监控、SQL审计、权限管理等特性保障企业数据安全。
            ![image](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/0715232271/p824613.png)
        3. 选择步骤a上传的文件，其他参数保持默认即可。最后单击**导入完成**。
   2. 引用知识：完成知识库的创建后，在左侧导航栏单击**我的应用**。找到步骤1中创建的大模型应用，单击**管理**。打开**知识库检索增强**开关、点击**配置知识库**、选择知识库，最后单击右上角**发****布**。Prompt中会被自动添加一段信息，以便大模型在后续回答时参考检索出来的信息。
   ![image](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/0258685371/p896396.png)

### 方案验证

**一、通过访问应用，验证智能客服的可用性**

1. 在[ROS控制台资源栈列表页](https://ros.console.aliyun.com/cn-hangzhou/stacks)，找到目标资源栈，单击资源栈ID，然后切换到**输出**页签。
2. 复制WebUrl的地址，粘贴到浏览器地址栏，访问AI智能客服。
3. 在提问框中提问，例如“哪款手机续航时间最长”。
   > 您可以看到此时大模型的回答参考了您上传的百炼系列手机产品介绍。

![image](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/6160078271/p858211.png)

**二、通过检查知识索引的命中，验证知识召回的准确性**

1.在百炼控制台，单击左侧导航栏的**数据应用**>**知识索引**，找到目标知识库，单击右侧**命中测试**。输入相应的问题，查看召回的知识切片及各切片的命中率。

![image](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/6160078271/p858209.png)

借助AnalyticDB for PostgreSQL的高效向量数据存储和检索，通过调整相似度阈值，可以优化知识召回的准确性，确保大模型在回答问题时参考到最相关的企业私域知识，从而生成更加准确和有用的回答。

### **完成及清理**

#### 清理资源

在本方案中，您创建了1台云服务器 ECS实例、1个云原生数据仓库 AnalyticDB PostgreSQL 版实例、1个百炼应用、1个安全组、1个交换机、1个专有网络 VPC。完成本文方案的体验后，如需删除资源，可按下文操作。

* 删除云服务器 ECS实例、云原生数据仓库 AnalyticDB PostgreSQL 版实例、安全组、交换机、专有网络 VPC，可以在[ROS控制台](https://ros.console.aliyun.com/overview)找到目标资源栈，单击删除，选择**删除方式**为**释放资源**。
* 删除百炼应用，需要登录[百炼控制台我的应用](https://bailian.console.aliyun.com/app-center#/app-center)页面，在应用卡片底部选择**更多**,点击**删除应用**。在**数据管理**页面和**数据应用** > **知识索引**页面，找到上传的数据和创建的知识库，单击**删除**。
